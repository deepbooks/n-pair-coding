<!doctype html>
<html>
<head>
    <title>SSH Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.2/socket.io.js" integrity="sha512-iZIBSs+gDyTH0ZhUem9eQ1t4DcEn2B9lHxfRMeGQhyNdSUz+rb+5A3ummX6DQTOIs1XK0gOteOg/LPtSo9VJ+w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="node_modules/xterm/css/xterm.css" />
    <script type="module" src="node_modules/xterm/lib/xterm.js"></script>
</head>

<body>

    <aside>
        <ul></ul>
    </aside>

<script>
// import { Terminal } from 'xterm';

const socket = io.connect('http://localhost:8081');

let mySids = [];
let xterms = {};
socket.on('connected', text => {
    const sids = JSON.parse(text);

    // rm old
    mySids.forEach(oid => {
        const some = sids.some(sid => sid === oid);
        if(!some) {
            rmDom(oid);
        }
    });

    // add new
    sids.forEach(sid => {
        const some = mySids.some(oid => oid === sid);
        if(!some) {
            addUserList(sid);
            addXterm(sid);
        }
    });

    mySids = sids;
});

socket.on('disconnected', sid => {
    rmDom(sid);
});

socket.on('output', text => {
    // textTerm(text);
    textXterm(text);
});

// Listen for user input and pass it to the server
window.addEventListener("keypress", e => {
    socket.emit("input", String.fromCharCode(e.charCode));
});
/* window.addEventListener("keydown", e => {
    socket.emit("input", String.fromCharCode((e.keyCode)));
});
function key2charCode(e) {
    return (typeof e.which == "number") ? e.which : e.keyCode;
} */

async function addUserList(name) {
    const uls = document.getElementsByTagName("ul");
    
    for(const ul of uls) {
        let non = true;

        const li = document.createElement('li');
        const a = document.createElement('a');
        li.name = a.innerText = a.name = name;
        a.href = '#'
        li.appendChild(a);
        ul.appendChild(li);
        a.click();
    }
}

function textXterm(text) {
    const terms = document.getElementsByTagName("article");
    const json = JSON.parse(text);
    for(const t of terms) {
        if(t.name === json.sid) {
            const term = xterms[t.name];
            term.write(json.data);
        }
    }
}

async function addXterm(name) {
    await setTimeout(() => 0, 1000);
    const term = new Terminal();
    xterms[name] = term;
    const article = document.createElement('article');
    document.body.appendChild(article);
    article.id = article.name = name;
    term.open(article);
    term.write(`Hello! ${socket.id}`);
}

async function addTerm(name) {
    const dom = getTermDom(name);
    document.body.appendChild(dom);
}

function textTerm(text) {
    const terms = document.getElementsByTagName("textarea");
    const json = JSON.parse(text);
    for(const term of terms) {
        if(term.name === json.sid) {
            term.value += term.textContext || json.data;
        }
    }
}

function clean(sids) {
    const doms = document.getElementsByName(sid);
}

function rmDom(name) {
    const doms = document.getElementsByName(name);
    if(doms && doms.length) {
        for(const dom of doms) {
            dom.remove();    
        }
    }
}

function getTermDom(name) {
    return htmlToElement(
        `<section name="${name}">
            <h1>SSH - ${name}</h1>
            <article>
                <textarea id="${name}" name="${name}" readonly></textarea>
            </article>
        </section>`);
}

/**
 * @param {String} HTML representing a single element
 * @return {Element}
 * 
 * ex:
 * const td = htmlToElement('<td>foo</td>');
 * const div = htmlToElement('<div><span>nested</span> <span>stuff</span></div>');
 * <ul> <li>1</li> <li>2</li> </ul>
 */
 function htmlToElement(html) {
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    
    return template.content.firstChild;
}

</script>

<style>
body {
    margin: 0;
    padding: 0;
}
article {
    pointer-events: none;
}
</style>

</body>
</html>
